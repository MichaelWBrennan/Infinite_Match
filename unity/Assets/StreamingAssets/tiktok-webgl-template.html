<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Unity WebGL Game on TikTok Mini Games">
    <title>Unity WebGL Game - TikTok Mini Games</title>
    
    <!-- TikTok Mini Games SDK -->
    <script src="https://sdk.tiktok.com/minis/v1/tiktok-minis-sdk.js"></script>
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #unity-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #unity-canvas {
            background: #231F20;
            display: block;
        }
        
        #unity-loading-bar {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        #unity-logo {
            width: 154px;
            height: 130px;
            background: url('TemplateData/unity-logo-dark.png') no-repeat center / contain;
        }
        
        #unity-progress-bar-empty {
            width: 141px;
            height: 18px;
            margin-top: 10px;
            background: url('TemplateData/progress-bar-empty-dark.png') no-repeat center / contain;
        }
        
        #unity-progress-bar-full {
            width: 0%;
            height: 18px;
            background: url('TemplateData/progress-bar-full-dark.png') no-repeat center / contain;
        }
        
        #unity-mobile-warning {
            position: absolute;
            left: 50%;
            top: 5%;
            transform: translate(-50%, -5%);
            background: #000;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .tiktok-loading {
            text-align: center;
            font-size: 18px;
            margin-top: 20px;
        }
        
        .tiktok-error {
            color: #ff6b6b;
            text-align: center;
            font-size: 16px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
            <div class="tiktok-loading">Loading game...</div>
        </div>
        <div id="unity-mobile-warning">
            WebGL builds are not supported on mobile devices.
        </div>
    </div>
    
    <script>
        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingBar = document.querySelector("#unity-loading-bar");
        var progressBarFull = document.querySelector("#unity-progress-bar-full");
        var mobileWarning = document.querySelector("#unity-mobile-warning");
        
        // TikTok Mini Games SDK Integration
        var tiktokSDK = null;
        var gameInstance = null;
        
        // Initialize TikTok Mini Games SDK
        function initializeTikTokSDK() {
            if (typeof TikTokMiniGame !== 'undefined') {
                tiktokSDK = TikTokMiniGame;
                console.log('üéµ TikTok Mini Games SDK initialized');
                
                // TikTok Mini Games initialization
                tiktokSDK.initialize().then(() => {
                    console.log('‚úÖ TikTok Mini Games ready');
                    startGame();
                }).catch((error) => {
                    console.error('‚ùå TikTok Mini Games initialization failed:', error);
                    showError('Failed to initialize TikTok Mini Games');
                });
            } else {
                console.warn('‚ö†Ô∏è TikTok Mini Games SDK not found, starting game without TikTok features');
                startGame();
            }
        }
        
        // Start the game
        function startGame() {
            // Show a mobile message if the user is on a mobile device
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                container.className = "unity-mobile";
                mobileWarning.style.display = "block";
                return;
            } else {
                canvas.style.width = "960px";
                canvas.style.height = "600px";
            }
            
            loadingBar.style.display = "block";
            
            var buildUrl = "Build";
            var loaderUrl = buildUrl + "/WebGL.loader.js";
            var config = {
                dataUrl: buildUrl + "/WebGL.data",
                frameworkUrl: buildUrl + "/WebGL.framework.js",
                codeUrl: buildUrl + "/WebGL.wasm",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "YourCompany",
                productName: "YourGame",
                productVersion: "1.0",
            };
            
            // Add TikTok Mini Games SDK to Unity config
            if (tiktokSDK) {
                config.tiktokSDK = tiktokSDK;
            }
            
            var script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    progressBarFull.style.width = 100 * progress + "%";
                }).then((unityInstance) => {
                    gameInstance = unityInstance;
                    loadingBar.style.display = "none";
                    
                    // TikTok Mini Games game ready callback
                    if (tiktokSDK) {
                        tiktokSDK.gameplayStart();
                    }
                    
                    console.log('‚úÖ Unity game loaded successfully');
                }).catch((message) => {
                    console.error('‚ùå Unity game load failed:', message);
                    showError('Failed to load game: ' + message);
                });
            };
            
            script.onerror = () => {
                console.error('‚ùå Failed to load Unity WebGL build');
                showError('Failed to load Unity WebGL build. Please check your browser console for errors.');
            };
            
            document.body.appendChild(script);
        }
        
        // Show error message
        function showError(message) {
            loadingBar.innerHTML = '<div class="tiktok-error">' + message + '</div>';
        }
        
        // TikTok Mini Games event handlers
        function onGamePause() {
            if (tiktokSDK) {
                tiktokSDK.gameplayStop();
            }
        }
        
        function onGameResume() {
            if (tiktokSDK) {
                tiktokSDK.gameplayStart();
            }
        }
        
        function onGameQuit() {
            if (tiktokSDK) {
                tiktokSDK.gameplayStop();
            }
        }
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                onGamePause();
            } else {
                onGameResume();
            }
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            onGameQuit();
        });
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            initializeTikTokSDK();
        });
        
        // TikTok Mini Games API functions for Unity
        window.TikTokAPI = {
            // Show TikTok ad
            showAd: function(type) {
                if (tiktokSDK) {
                    return tiktokSDK.ads.showAd(type);
                }
                return Promise.resolve();
            },
            
            // Show banner ad
            showBannerAd: function() {
                if (tiktokSDK) {
                    return tiktokSDK.ads.showBannerAd();
                }
                return Promise.resolve();
            },
            
            // Show rewarded ad
            showRewardedAd: function() {
                if (tiktokSDK) {
                    return tiktokSDK.ads.showRewardedAd();
                }
                return Promise.resolve();
            },
            
            // Show interstitial ad
            showInterstitialAd: function() {
                if (tiktokSDK) {
                    return tiktokSDK.ads.showInterstitialAd();
                }
                return Promise.resolve();
            },
            
            // Share game
            shareGame: function(message) {
                if (tiktokSDK) {
                    return tiktokSDK.social.share(message);
                }
                return Promise.resolve();
            },
            
            // Update player score
            updatePlayerScore: function(score) {
                if (tiktokSDK) {
                    return tiktokSDK.social.updateScore(score);
                }
                return Promise.resolve();
            },
            
            // Create video
            createVideo: function(content) {
                if (tiktokSDK) {
                    return tiktokSDK.video.create(content);
                }
                return Promise.resolve();
            },
            
            // Use trending feature
            useTrendingFeature: function(featureName) {
                if (tiktokSDK) {
                    return tiktokSDK.trending.useFeature(featureName);
                }
                return Promise.resolve();
            },
            
            // Use hashtag
            useHashtag: function(hashtag) {
                if (tiktokSDK) {
                    return tiktokSDK.hashtags.use(hashtag);
                }
                return Promise.resolve();
            },
            
            // Get player info
            getPlayerInfo: function() {
                if (tiktokSDK) {
                    return tiktokSDK.player;
                }
                return null;
            },
            
            // Track game event
            trackEvent: function(eventName, data) {
                if (tiktokSDK) {
                    tiktokSDK.analytics.track(eventName, data);
                }
            }
        };
    </script>
</body>
</html>