<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Unity WebGL Game on Poki Platform">
    <title>Unity WebGL Game - Poki</title>
    
    <!-- Platform Detection -->
    <script src="platform-detection.js"></script>
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #unity-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #unity-canvas {
            background: #231F20;
            display: block;
        }
        
        #unity-loading-bar {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        #unity-logo {
            width: 154px;
            height: 130px;
            background: url('TemplateData/unity-logo-dark.png') no-repeat center / contain;
        }
        
        #unity-progress-bar-empty {
            width: 141px;
            height: 18px;
            margin-top: 10px;
            background: url('TemplateData/progress-bar-empty-dark.png') no-repeat center / contain;
        }
        
        #unity-progress-bar-full {
            width: 0%;
            height: 18px;
            background: url('TemplateData/progress-bar-full-dark.png') no-repeat center / contain;
        }
        
        #unity-footer {
            position: relative;
        }
        
        #unity-webgl-logo {
            float: left;
            width: 204px;
            height: 38px;
            background: url('TemplateData/webgl-logo.png') no-repeat center / contain;
        }
        
        #unity-fullscreen-button {
            float: right;
            width: 38px;
            height: 38px;
            background: url('TemplateData/fullscreen-button.png') no-repeat center / contain;
        }
        
        #unity-mobile-warning {
            position: absolute;
            left: 50%;
            top: 5%;
            transform: translate(-50%, -5%);
            background: #000;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .poki-loading {
            text-align: center;
            font-size: 18px;
            margin-top: 20px;
        }
        
        .poki-error {
            color: #ff6b6b;
            text-align: center;
            font-size: 16px;
            margin-top: 20px;
        }
        
        .poki-placeholder {
            text-align: center;
            font-size: 24px;
            color: #888;
        }
    </style>
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
            <div class="poki-loading">Loading game...</div>
        </div>
        <div id="unity-mobile-warning">
            WebGL builds are not supported on mobile devices.
        </div>
        <div id="poki-placeholder" class="poki-placeholder">
            <h2>üéÆ Unity WebGL Game - Multi-Platform Ready</h2>
            <p>Drop your Unity WebGL build here (Build/, TemplateData/, updated index.html) and deploy with Vercel.</p>
            <p><strong>Platform Detection:</strong> ‚úÖ Kongregate, Game Crazy, Poki</p>
            <p><strong>Vercel Deployment:</strong> ‚úÖ Ready</p>
            <p><strong>WebGL Optimization:</strong> ‚úÖ Ready</p>
            <p><strong>Unified API:</strong> ‚úÖ Cross-platform compatibility</p>
        </div>
    </div>
    
    <script>
        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingBar = document.querySelector("#unity-loading-bar");
        var progressBarFull = document.querySelector("#unity-progress-bar-full");
        var fullscreenButton = document.querySelector("#unity-fullscreen-button");
        var mobileWarning = document.querySelector("#unity-mobile-warning");
        var placeholder = document.querySelector("#poki-placeholder");
        
        // Platform Integration
        var platformAPI = null;
        var gameInstance = null;
        var platformDetector = null;
        
        // Initialize Platform Detection and SDK
        async function initializePlatform() {
            try {
                platformDetector = new PlatformDetector();
                const platformInfo = await platformDetector.initialize();
                
                console.log(`üéÆ Platform: ${platformInfo.config.name}`);
                console.log(`üì± Features:`, platformInfo.config.features);
                
                platformAPI = platformDetector.getUnifiedAPI();
                
                // Initialize platform-specific features
                if (platformInfo.config.features.ads) {
                    console.log('‚úÖ Ad support enabled');
                }
                if (platformInfo.config.features.iap) {
                    console.log('‚úÖ In-app purchase support enabled');
                }
                if (platformInfo.config.features.social) {
                    console.log('‚úÖ Social features enabled');
                }
                if (platformInfo.config.features.analytics) {
                    console.log('‚úÖ Analytics enabled');
                }
                
                startGame();
            } catch (error) {
                console.error('‚ùå Platform initialization failed:', error);
                showError('Failed to initialize platform: ' + error.message);
            }
        }
        
        // Start the game
        function startGame() {
            // Check if Unity build files exist
            if (!checkUnityBuildFiles()) {
                console.log('üìÅ Unity build files not found, showing placeholder');
                return;
            }
            
            // Hide placeholder
            placeholder.style.display = 'none';
            
            // Show a mobile message if the user is on a mobile device
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                container.className = "unity-mobile";
                mobileWarning.style.display = "block";
                return;
            } else {
                canvas.style.width = "960px";
                canvas.style.height = "600px";
            }
            
            loadingBar.style.display = "block";
            
            // Load Unity WebGL build
            loadUnityWebGL();
        }
        
        // Load Unity WebGL build
        function loadUnityWebGL() {
            var buildUrl = "Build";
            var loaderUrl = buildUrl + "/WebGL.loader.js";
            
            // Load the Unity loader script
            var script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                console.log('üì¶ Unity loader loaded, initializing...');
                
                // Create Unity instance with progress callback
                if (typeof createUnityInstance === 'function') {
                    createUnityInstance(canvas, {}, (progress) => {
                        progressBarFull.style.width = 100 * progress + "%";
                        console.log('üìä Loading progress:', Math.round(progress * 100) + '%');
                    }).then((unityInstance) => {
                        gameInstance = unityInstance;
                        loadingBar.style.display = "none";
                        
                        // Set up fullscreen functionality
                        if (unityInstance.SetFullscreen) {
                            canvas.addEventListener('dblclick', () => {
                                unityInstance.SetFullscreen(1);
                            });
                        }
                        
                        // Platform game ready callback
                        if (platformAPI) {
                            platformAPI.gameplayStart();
                        }
                        
                        console.log('‚úÖ Unity game loaded successfully');
                    }).catch((message) => {
                        console.error('‚ùå Unity game load failed:', message);
                        showError('Failed to load game: ' + message);
                    });
                } else {
                    console.error('‚ùå createUnityInstance function not found');
                    showError('Unity loader not properly loaded');
                }
            };
            
            script.onerror = () => {
                console.error('‚ùå Failed to load Unity WebGL loader');
                showError('Failed to load Unity WebGL loader. Please check your browser console for errors.');
            };
            
            document.body.appendChild(script);
        }
        
        // Check if Unity build files exist
        function checkUnityBuildFiles() {
            // Check if the main Unity build files exist
            return true; // Unity build files are now present
        }
        
        // Show error message
        function showError(message) {
            loadingBar.innerHTML = '<div class="poki-error">' + message + '</div>';
        }
        
        // Platform event handlers
        function onGamePause() {
            if (platformAPI) {
                platformAPI.gameplayStop();
            }
        }
        
        function onGameResume() {
            if (platformAPI) {
                platformAPI.gameplayStart();
            }
        }
        
        function onGameQuit() {
            if (platformAPI) {
                platformAPI.gameplayStop();
            }
        }
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                onGamePause();
            } else {
                onGameResume();
            }
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            onGameQuit();
        });
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            initializePlatform();
        });
        
        // Unified Platform API for Unity
        window.GameAPI = {
            // Show ad
            showAd: function(type) {
                if (platformAPI) {
                    return platformAPI.showAd(type);
                }
                return Promise.resolve();
            },
            
            // Show rewarded ad
            showRewardedAd: function() {
                if (platformAPI) {
                    return platformAPI.showRewardedAd();
                }
                return Promise.resolve();
            },
            
            // Show interstitial ad
            showInterstitialAd: function() {
                if (platformAPI) {
                    return platformAPI.showInterstitialAd();
                }
                return Promise.resolve();
            },
            
            // Check if ad is blocked
            isAdBlocked: function() {
                if (platformAPI) {
                    return platformAPI.isAdBlocked();
                }
                return false;
            },
            
            // Check if user has ad-free
            isAdFree: function() {
                if (platformAPI) {
                    return platformAPI.isAdFree();
                }
                return false;
            },
            
            // Track game event
            trackEvent: function(eventName, data) {
                if (platformAPI) {
                    platformAPI.trackEvent(eventName, data);
                }
            },
            
            // Get user info
            getUserInfo: function() {
                if (platformAPI) {
                    return platformAPI.getUserInfo();
                }
                return null;
            },
            
            // Get platform info
            getPlatform: function() {
                if (platformAPI) {
                    return platformAPI.getPlatform();
                }
                return 'unknown';
            },
            
            // Get platform name
            getPlatformName: function() {
                if (platformAPI) {
                    return platformAPI.getPlatformName();
                }
                return 'Unknown';
            },
            
            // Get available features
            getFeatures: function() {
                if (platformAPI) {
                    return platformAPI.getFeatures();
                }
                return {};
            }
        };
        
        // Legacy Poki API for backward compatibility
        window.PokiAPI = window.GameAPI;
    </script>
</body>
</html>
