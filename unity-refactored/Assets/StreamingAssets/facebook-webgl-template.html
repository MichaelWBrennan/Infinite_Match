<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Unity WebGL Game on Facebook Instant Games">
    <title>Unity WebGL Game - Facebook Instant Games</title>
    
    <!-- Facebook Instant Games SDK -->
    <script src="https://connect.facebook.net/en_US/fbinstant.6.3.js"></script>
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #unity-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #unity-canvas {
            background: #231F20;
            display: block;
        }
        
        #unity-loading-bar {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        #unity-logo {
            width: 154px;
            height: 130px;
            background: url('TemplateData/unity-logo-dark.png') no-repeat center / contain;
        }
        
        #unity-progress-bar-empty {
            width: 141px;
            height: 18px;
            margin-top: 10px;
            background: url('TemplateData/progress-bar-empty-dark.png') no-repeat center / contain;
        }
        
        #unity-progress-bar-full {
            width: 0%;
            height: 18px;
            background: url('TemplateData/progress-bar-full-dark.png') no-repeat center / contain;
        }
        
        #unity-mobile-warning {
            position: absolute;
            left: 50%;
            top: 5%;
            transform: translate(-50%, -5%);
            background: #000;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .facebook-loading {
            text-align: center;
            font-size: 18px;
            margin-top: 20px;
        }
        
        .facebook-error {
            color: #ff6b6b;
            text-align: center;
            font-size: 16px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
            <div class="facebook-loading">Loading game...</div>
        </div>
        <div id="unity-mobile-warning">
            WebGL builds are not supported on mobile devices.
        </div>
    </div>
    
    <script>
        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingBar = document.querySelector("#unity-loading-bar");
        var progressBarFull = document.querySelector("#unity-progress-bar-full");
        var mobileWarning = document.querySelector("#unity-mobile-warning");
        
        // Facebook Instant Games SDK Integration
        var facebookSDK = null;
        var gameInstance = null;
        
        // Initialize Facebook Instant Games SDK
        function initializeFacebookSDK() {
            if (typeof FBInstant !== 'undefined') {
                facebookSDK = FBInstant;
                console.log('üìò Facebook Instant Games SDK initialized');
                
                // Facebook Instant Games initialization
                facebookSDK.initializeAsync().then(() => {
                    console.log('‚úÖ Facebook Instant Games ready');
                    startGame();
                }).catch((error) => {
                    console.error('‚ùå Facebook Instant Games initialization failed:', error);
                    showError('Failed to initialize Facebook Instant Games');
                });
            } else {
                console.warn('‚ö†Ô∏è Facebook Instant Games SDK not found, starting game without Facebook features');
                startGame();
            }
        }
        
        // Start the game
        function startGame() {
            // Show a mobile message if the user is on a mobile device
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                container.className = "unity-mobile";
                mobileWarning.style.display = "block";
                return;
            } else {
                canvas.style.width = "960px";
                canvas.style.height = "600px";
            }
            
            loadingBar.style.display = "block";
            
            var buildUrl = "Build";
            var loaderUrl = buildUrl + "/WebGL.loader.js";
            var config = {
                dataUrl: buildUrl + "/WebGL.data",
                frameworkUrl: buildUrl + "/WebGL.framework.js",
                codeUrl: buildUrl + "/WebGL.wasm",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "YourCompany",
                productName: "YourGame",
                productVersion: "1.0",
            };
            
            // Add Facebook Instant Games SDK to Unity config
            if (facebookSDK) {
                config.facebookSDK = facebookSDK;
            }
            
            var script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    progressBarFull.style.width = 100 * progress + "%";
                }).then((unityInstance) => {
                    gameInstance = unityInstance;
                    loadingBar.style.display = "none";
                    
                    // Facebook Instant Games game ready callback
                    if (facebookSDK) {
                        facebookSDK.startGameAsync();
                    }
                    
                    console.log('‚úÖ Unity game loaded successfully');
                }).catch((message) => {
                    console.error('‚ùå Unity game load failed:', message);
                    showError('Failed to load game: ' + message);
                });
            };
            
            script.onerror = () => {
                console.error('‚ùå Failed to load Unity WebGL build');
                showError('Failed to load Unity WebGL build. Please check your browser console for errors.');
            };
            
            document.body.appendChild(script);
        }
        
        // Show error message
        function showError(message) {
            loadingBar.innerHTML = '<div class="facebook-error">' + message + '</div>';
        }
        
        // Facebook Instant Games event handlers
        function onGamePause() {
            if (facebookSDK) {
                facebookSDK.pauseAsync();
            }
        }
        
        function onGameResume() {
            if (facebookSDK) {
                facebookSDK.resumeAsync();
            }
        }
        
        function onGameQuit() {
            if (facebookSDK) {
                facebookSDK.quitAsync();
            }
        }
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                onGamePause();
            } else {
                onGameResume();
            }
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            onGameQuit();
        });
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            initializeFacebookSDK();
        });
        
        // Facebook Instant Games API functions for Unity
        window.FacebookAPI = {
            // Show Facebook ad
            showAd: function(type) {
                if (facebookSDK) {
                    return facebookSDK.showAdAsync();
                }
                return Promise.resolve();
            },
            
            // Show rewarded ad
            showRewardedAd: function() {
                if (facebookSDK) {
                    return facebookSDK.showRewardedAdAsync();
                }
                return Promise.resolve();
            },
            
            // Show interstitial ad
            showInterstitialAd: function() {
                if (facebookSDK) {
                    return facebookSDK.showAdAsync();
                }
                return Promise.resolve();
            },
            
            // Purchase product
            purchaseProduct: function(productId, price) {
                if (facebookSDK) {
                    return facebookSDK.payments.purchaseAsync({
                        productID: productId,
                        developerPayload: 'payload'
                    });
                }
                return Promise.resolve();
            },
            
            // Share game
            shareGame: function(message) {
                if (facebookSDK) {
                    return facebookSDK.shareAsync({
                        intent: 'SHARE',
                        text: message
                    });
                }
                return Promise.resolve();
            },
            
            // Update player score
            updatePlayerScore: function(score) {
                if (facebookSDK) {
                    return facebookSDK.setScoreAsync(score);
                }
                return Promise.resolve();
            },
            
            // Get player info
            getPlayerInfo: function() {
                if (facebookSDK) {
                    return facebookSDK.player;
                }
                return null;
            },
            
            // Track game event
            trackEvent: function(eventName, data) {
                if (facebookSDK) {
                    facebookSDK.logEvent(eventName, data);
                }
            }
        };
    </script>
</body>
</html>