# Unity CLI Automation Workflow

This workflow provides automated deployment of Unity Cloud Services using the Unity CLI with rollback capabilities.

## Features

- ✅ **Unity CLI Integration**: Uses the official Unity CLI for all operations
- ✅ **Automated Backup**: Creates backups before deployment
- ✅ **Rollback Support**: Automatically rolls back on deployment failure
- ✅ **Economy Management**: Deploys currencies, inventory items, and catalog items
- ✅ **Remote Config**: Deploys remote configuration settings
- ✅ **Cloud Code**: Deploys JavaScript cloud functions
- ✅ **Comprehensive Reporting**: Generates detailed deployment reports
- ✅ **Artifact Storage**: Saves all data and reports as GitHub artifacts

## Prerequisites

### Required GitHub Secrets

Add these secrets to your repository settings:

```bash
UNITY_PROJECT_ID=your-unity-project-id
UNITY_ENV_ID=your-environment-id
UNITY_CLIENT_ID=your-unity-client-id
UNITY_CLIENT_SECRET=your-unity-client-secret
```

### How to Get Unity Credentials

1. **Project ID & Environment ID**:
   - Go to [Unity Dashboard](https://dashboard.unity3d.com)
   - Select your project
   - Copy the Project ID and Environment ID from the URL

2. **Client ID & Client Secret**:
   - Go to Unity Dashboard → Settings → API Keys
   - Create a new API key
   - Copy the Client ID and Client Secret

## Directory Structure

The workflow automatically converts your existing economy CSV:

```
├── unity/Assets/StreamingAssets/
│   └── economy_items.csv          # ← Your existing economy data
├── economy/                       # ← Generated by workflow
│   ├── currencies.csv
│   ├── inventory.csv
│   └── catalog.csv
├── remote-config/                 # ← Generated by workflow
│   └── game_config.json
├── cloud-code/                    # ← Generated by workflow
│   ├── AddCurrency.js
│   ├── SpendCurrency.js
│   ├── AddInventoryItem.js
│   └── UseInventoryItem.js
└── .github/workflows/
    └── unity-cli-automation.yml
```

### Your Existing Economy Data

The workflow automatically detects and converts your existing `economy_items.csv` file, which contains:
- **20 economy items** (7 currency packs, 4 boosters, 9 packs)
- **5 coin packs** (Small, Medium, Large, Mega, Ultimate)
- **2 energy packs** (Small, Large)
- **4 boosters** (Extra Moves, Color Bomb, Rainbow Blast, Striped Candy)
- **9 packs** (Starter, Value, Premium, Mega, Ultimate, Booster Bundle, Power Pack, Comeback, Flash Sale)

## File Formats

### Economy Files

#### currencies.csv
```csv
id,name,type,initial,maximum
coins,Coins,soft_currency,1000,999999
gems,Gems,hard_currency,50,99999
energy,Energy,consumable,5,30
```

#### inventory.csv
```csv
id,name,type,tradable,stackable
booster_extra_moves,Extra Moves,booster,true,true
booster_color_bomb,Color Bomb,booster,true,true
pack_starter,Starter Pack,pack,false,false
```

#### catalog.csv
```csv
id,name,cost_currency,cost_amount,rewards
coins_small,Small Coin Pack,gems,20,coins:1000
coins_medium,Medium Coin Pack,gems,120,coins:5000
energy_small,Energy Boost,gems,5,energy:5
```

### Remote Config Files

#### game_config.json
```json
{
  "game_settings": {
    "max_level": 100,
    "energy_refill_time": 300,
    "daily_reward_coins": 100,
    "daily_reward_gems": 5
  },
  "economy_settings": {
    "coin_multiplier": 1.0,
    "gem_multiplier": 1.0,
    "sale_discount": 0.5
  },
  "feature_flags": {
    "new_levels_enabled": true,
    "daily_challenges_enabled": true,
    "social_features_enabled": false
  }
}
```

### Cloud Code Files

#### AddCurrency.js
```javascript
const { EconomyApi } = require("@unity-services/economy-1.0");

module.exports = async ({ params, context, logger }) => {
  try {
    const { currencyId, amount } = params;
    
    if (!currencyId || !amount) {
      throw new Error("Missing required parameters: currencyId, amount");
    }
    
    if (amount <= 0) {
      throw new Error("Amount must be positive");
    }
    
    await EconomyApi.addCurrency({
      currencyId: currencyId,
      amount: amount
    });
    
    logger.info(`Added ${amount} ${currencyId} to player`);
    
    return {
      success: true,
      currencyId: currencyId,
      amount: amount
    };
  } catch (error) {
    logger.error(`AddCurrency failed: ${error.message}`);
    throw error;
  }
};
```

## Workflow Triggers

The workflow runs automatically when:
- Files in `economy/` directory change
- Files in `remote-config/` directory change
- Files in `cloud-code/` directory change
- **Files in `unity/Assets/StreamingAssets/economy_items.csv` change** ← Your existing file!

You can also trigger it manually via GitHub Actions UI.

## Automatic Conversion

The workflow automatically converts your existing `economy_items.csv` into the format needed for Unity CLI:

1. **Detects** your existing economy CSV file
2. **Converts** it into separate currencies, inventory, and catalog files
3. **Generates** remote config and cloud code files
4. **Deploys** everything to Unity Cloud Services
5. **Creates** backups and rollback capability

### Manual Conversion (Optional)

You can also run the conversion locally:

```bash
# Quick conversion
./convert_economy.sh

# Or run the Python script directly
python3 scripts/convert_economy_csv.py
```

This will generate all the necessary files in your local repository.

## Workflow Steps

1. **Setup**: Installs Unity CLI and authenticates
2. **Backup**: Creates backups of current configuration
3. **Prepare**: Prepares data files for deployment
4. **Deploy**: Deploys economy, remote config, and cloud code
5. **Verify**: Verifies deployment success
6. **Rollback**: Rolls back on failure (if needed)
7. **Report**: Generates deployment report
8. **Upload**: Saves artifacts and reports

## Rollback Mechanism

If any deployment step fails:
1. The workflow automatically stops
2. Previous backups are restored
3. A rollback report is generated
4. All artifacts are saved for debugging

## Monitoring

### GitHub Actions UI
- View workflow runs in the Actions tab
- Download artifacts from each run
- Check logs for detailed information

### Deployment Reports
Each run generates a report containing:
- Deployment timestamp
- Status (success/failure)
- Files processed
- Backup files created
- Unity CLI version

## Troubleshooting

### Common Issues

1. **Authentication Failed**:
   - Check Unity credentials in repository secrets
   - Verify API key has correct permissions

2. **Project Access Denied**:
   - Ensure API key has access to the project
   - Check Project ID and Environment ID

3. **File Format Errors**:
   - Validate CSV files have correct headers
   - Check JSON files are valid
   - Ensure JavaScript files have correct syntax

4. **Deployment Failures**:
   - Check Unity CLI logs
   - Verify file permissions
   - Ensure all required fields are present

### Debug Mode

To enable debug logging:
1. Go to repository Settings → Secrets and variables → Actions
2. Add a new secret: `ACTIONS_STEP_DEBUG` = `true`
3. Re-run the workflow

## Best Practices

1. **Test First**: Always test changes in a development environment
2. **Small Changes**: Make small, incremental changes
3. **Backup Regularly**: Keep backups of working configurations
4. **Monitor Logs**: Check logs after each deployment
5. **Version Control**: Keep all configuration files in version control

## Support

For issues or questions:
1. Check the GitHub Actions logs
2. Review the deployment report
3. Verify Unity CLI documentation
4. Contact the development team

## Example Usage

1. **Add a new currency**:
   - Edit `economy/currencies.csv`
   - Commit and push changes
   - Workflow runs automatically

2. **Update remote config**:
   - Edit `remote-config/game_config.json`
   - Commit and push changes
   - Workflow runs automatically

3. **Deploy new cloud function**:
   - Add new `.js` file to `cloud-code/`
   - Commit and push changes
   - Workflow runs automatically

The workflow will handle everything else automatically!