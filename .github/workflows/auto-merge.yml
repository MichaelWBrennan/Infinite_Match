name: Auto-Merge Successful PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

env:
  NODE_VERSION: '22'

jobs:
  auto-merge-check:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run automated checks
        run: |
          echo "ğŸ” Running automated checks for auto-merge..."
          npm run lint
          npm run format:check
          npm test
          echo "âœ… All checks passed"

      - name: Check if PR is ready for auto-merge
        id: check-pr
        run: |
          # Check if PR has required labels or meets criteria
          if [ "${{ github.event.pull_request.labels.*.name }}" = *"auto-merge"* ] || [ "${{ github.event.pull_request.labels.*.name }}" = *"ready-to-merge"* ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "âœ… PR is ready for auto-merge"
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ PR needs 'auto-merge' or 'ready-to-merge' label"
          fi

      - name: Auto-merge PR
        if: steps.check-pr.outputs.ready == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            
            // Check if all required status checks are passing
            const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
              owner,
              repo,
              ref: context.payload.pull_request.head.sha
            });
            
            const allChecksPassing = statuses.every(status => status.state === 'success');
            
            if (allChecksPassing) {
              console.log('âœ… All status checks are passing, proceeding with merge...');
              
              try {
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: number,
                  merge_method: 'squash',
                  commit_title: `Auto-merge: ${context.payload.pull_request.title}`,
                  commit_message: `Automatically merged PR #${number}\n\n${context.payload.pull_request.body || ''}`
                });
                
                console.log('ğŸ‰ PR successfully auto-merged!');
                
                // Add success comment
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: number,
                  body: 'ğŸ‰ **Auto-merge successful!**\n\nThis PR has been automatically merged because:\n- âœ… All automated checks passed\n- âœ… PR was labeled for auto-merge\n- âœ… No conflicts detected\n\nDeployment will begin automatically.'
                });
                
              } catch (error) {
                console.error('âŒ Auto-merge failed:', error);
                
                // Add failure comment
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: number,
                  body: 'âŒ **Auto-merge failed!**\n\nPlease check the logs and try again manually.'
                });
              }
            } else {
              console.log('â³ Waiting for all status checks to pass...');
              
              // Add waiting comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: number,
                body: 'â³ **Auto-merge pending...**\n\nWaiting for all status checks to pass before merging.'
              });
            }

  notify-team:
    runs-on: ubuntu-latest
    needs: auto-merge-check
    if: always()
    steps:
      - name: Notify team of auto-merge status
        run: |
          if [ "${{ needs.auto-merge-check.result }}" = "success" ]; then
            echo "ğŸ‰ Auto-merge completed successfully!"
            echo "ğŸ“§ Team notification sent"
          else
            echo "â„¹ï¸ Auto-merge check completed"
          fi