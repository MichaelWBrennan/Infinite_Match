{"version":3,"file":"joined-config.js","sourceRoot":"","sources":["../../../src/config/joined-config.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  AutocaptureOptions,\n  type ElementInteractionsOptions,\n  BrowserConfig,\n  RemoteConfig,\n  NetworkTrackingOptions,\n  NetworkCaptureRule,\n  SAFE_HEADERS,\n} from '@amplitude/analytics-core';\n\nexport interface AutocaptureOptionsRemoteConfig extends AutocaptureOptions {\n  elementInteractions?: boolean | ElementInteractionsOptionsRemoteConfig;\n  networkTracking?: boolean | NetworkTrackingOptionsRemoteConfig;\n}\nexport interface ElementInteractionsOptionsRemoteConfig extends ElementInteractionsOptions {\n  /**\n   * Related to pageUrlAllowlist but holds regex strings which will be initialized and appended to pageUrlAllowlist\n   */\n  pageUrlAllowlistRegex?: string[];\n}\n\nexport interface NetworkCaptureRuleRemoteConfig extends NetworkCaptureRule {\n  /**\n   * Related to urls but holds regex strings which will be initialized and appended to urls\n   */\n  urlsRegex?: string[];\n}\n\nexport interface NetworkTrackingOptionsRemoteConfig extends NetworkTrackingOptions {\n  /**\n   * Related to pageUrlAllowlist but holds regex strings which will be initialized and appended to pageUrlAllowlist\n   */\n  captureRules?: NetworkCaptureRuleRemoteConfig[];\n}\n\n// Type alias for the remote config structure we expect (this is what comes from the filtered browserSDK config)\ntype RemoteConfigBrowserSDK = {\n  autocapture?: AutocaptureOptionsRemoteConfig | boolean;\n};\n\n/**\n * Performs a deep transformation of a remote config object so that\n * it matches the expected schema of the local config.\n *\n * Specifically, it normalizes nested `enabled` flags into concise union types.\n *\n * ### Transformation Rules:\n * - If an object has `enabled: true`, it is replaced by the same object without the `enabled` field.\n * - If it has only `enabled: true`, it is replaced with `true`.\n * - If it has `enabled: false`, it is replaced with `false` regardless of other fields.\n *\n * ### Examples:\n * Input:  { prop: { enabled: true, hello: 'world' }}\n * Output: { prop: { hello: 'world' } }\n *\n * Input:  { prop: { enabled: true }}\n * Output: { prop: true }\n *\n * Input:  { prop: { enabled: false, hello: 'world' }}\n * Output: { prop: false }\n *\n * Input:  { prop: { hello: 'world' }}\n * Output: { prop: { hello: 'world' } } // No change\n *\n * @param config Remote config object to be transformed\n * @returns Transformed config object compatible with local schema\n */\nexport function translateRemoteConfigToLocal(config?: Record<string, any>) {\n  // Disabling type checking rules because remote config comes from a remote source\n  // and this function needs to handle any unexpected values\n  /* eslint-disable @typescript-eslint/no-unsafe-member-access,\n     @typescript-eslint/no-unsafe-assignment,\n     @typescript-eslint/no-unsafe-argument\n */\n  if (typeof config !== 'object' || config === null) {\n    return;\n  }\n\n  // translations are not applied on array properties\n  if (Array.isArray(config)) {\n    return;\n  }\n\n  const propertyNames = Object.keys(config);\n  for (const propertyName of propertyNames) {\n    try {\n      const value = config[propertyName];\n      // transform objects with { enabled } property to boolean | object\n      if (typeof value?.enabled === 'boolean') {\n        if (value.enabled) {\n          // if enabled is true, set the value to the rest of the object\n          // or true if the object has no other properties\n          delete value.enabled;\n          if (Object.keys(value).length === 0) {\n            (config as any)[propertyName] = true;\n          }\n        } else {\n          // If enabled is false, set the value to false\n          (config as any)[propertyName] = false;\n        }\n      }\n\n      // recursively translate properties of the value\n      translateRemoteConfigToLocal(value as Record<string, any>);\n    } catch (e) {\n      // a failure here means that an accessor threw an error\n      // so don't translate it\n      // TODO(diagnostics): add a diagnostic event for this\n    }\n  }\n\n  // translate remote responseHeaders and requestHeaders to local responseHeaders and requestHeaders\n  try {\n    if (config.autocapture?.networkTracking?.captureRules?.length) {\n      for (const rule of config.autocapture.networkTracking.captureRules) {\n        for (const header of ['responseHeaders', 'requestHeaders']) {\n          const { captureSafeHeaders, allowlist } = rule[header] ?? {};\n          if (!captureSafeHeaders && !allowlist) {\n            continue;\n          }\n          // if allowlist is not an array, remote config contract is violated, remove it\n          if (allowlist !== undefined && !Array.isArray(allowlist)) {\n            delete rule[header];\n            continue;\n          }\n          rule[header] = [...(captureSafeHeaders ? SAFE_HEADERS : []), ...(allowlist ?? [])];\n        }\n      }\n    }\n  } catch (e) {\n    /* istanbul ignore next */\n    // surprise exception, so don't translate it\n  }\n\n  // translate frustrationInteractions pluralization\n  const frustrationInteractions = config.autocapture?.frustrationInteractions;\n  if (frustrationInteractions) {\n    if (frustrationInteractions.rageClick) {\n      frustrationInteractions.rageClicks = frustrationInteractions.rageClick;\n      delete frustrationInteractions.rageClick;\n    }\n    if (frustrationInteractions.deadClick) {\n      frustrationInteractions.deadClicks = frustrationInteractions.deadClick;\n      delete frustrationInteractions.deadClick;\n    }\n  }\n}\n\nfunction mergeUrls(urlsExact: (string | RegExp)[], urlsRegex: string[] | undefined, browserConfig: BrowserConfig) {\n  // Convert string patterns to RegExp objects, warn on invalid patterns and skip them\n  const regexList = [];\n  for (const pattern of urlsRegex ?? []) {\n    try {\n      regexList.push(new RegExp(pattern));\n    } catch (regexError) {\n      browserConfig.loggerProvider.warn(`Invalid regex pattern: ${pattern}`, regexError);\n    }\n  }\n\n  return urlsExact.concat(regexList);\n}\n\n/**\n * Updates the browser config in place by applying remote configuration settings.\n * Primarily merges autocapture settings from the remote config into the browser config.\n *\n * @param remoteConfig - The remote configuration to apply, or null if none available\n * @param browserConfig - The browser config object to update (modified in place)\n */\nexport function updateBrowserConfigWithRemoteConfig(\n  remoteConfig: RemoteConfig | null,\n  browserConfig: BrowserConfig,\n): void {\n  if (!remoteConfig) {\n    return;\n  }\n\n  // translate remote config to local compatible format\n  translateRemoteConfigToLocal(remoteConfig);\n\n  try {\n    browserConfig.loggerProvider.debug(\n      'Update browser config with remote configuration:',\n      JSON.stringify(remoteConfig),\n    );\n\n    // type cast error will be thrown if remoteConfig is not a valid RemoteConfigBrowserSDK\n    // and it will be caught by the try-catch block\n    const typedRemoteConfig = remoteConfig as RemoteConfigBrowserSDK;\n\n    // merge remoteConfig.autocapture and browserConfig.autocapture\n    // if a field is in remoteConfig.autocapture, use that value\n    // if a field is not in remoteConfig.autocapture, use the value from browserConfig.autocapture\n    if (typedRemoteConfig && 'autocapture' in typedRemoteConfig) {\n      if (typeof typedRemoteConfig.autocapture === 'boolean') {\n        browserConfig.autocapture = typedRemoteConfig.autocapture;\n      }\n\n      if (typeof typedRemoteConfig.autocapture === 'object' && typedRemoteConfig.autocapture !== null) {\n        const transformedAutocaptureRemoteConfig = { ...typedRemoteConfig.autocapture };\n\n        if (browserConfig.autocapture === undefined) {\n          browserConfig.autocapture = typedRemoteConfig.autocapture;\n        }\n\n        // Handle Element Interactions config initialization\n        if (\n          typeof typedRemoteConfig.autocapture.elementInteractions === 'object' &&\n          typedRemoteConfig.autocapture.elementInteractions !== null &&\n          typedRemoteConfig.autocapture.elementInteractions.pageUrlAllowlistRegex?.length\n        ) {\n          transformedAutocaptureRemoteConfig.elementInteractions = {\n            ...typedRemoteConfig.autocapture.elementInteractions,\n          };\n          const transformedRcElementInteractions = transformedAutocaptureRemoteConfig.elementInteractions;\n\n          // combine exact allow list and regex allow list into just 'pageUrlAllowlist'\n          const exactAllowList = transformedRcElementInteractions.pageUrlAllowlist ?? [];\n          const urlsRegex = typedRemoteConfig.autocapture.elementInteractions.pageUrlAllowlistRegex;\n          transformedRcElementInteractions.pageUrlAllowlist = mergeUrls(exactAllowList, urlsRegex, browserConfig);\n\n          // clean up the regex allow list\n          delete transformedRcElementInteractions.pageUrlAllowlistRegex;\n        }\n\n        // Handle Network Tracking config initialization\n        if (\n          typeof typedRemoteConfig.autocapture.networkTracking === 'object' &&\n          typedRemoteConfig.autocapture.networkTracking !== null &&\n          typedRemoteConfig.autocapture.networkTracking.captureRules?.length\n        ) {\n          transformedAutocaptureRemoteConfig.networkTracking = {\n            ...typedRemoteConfig.autocapture.networkTracking,\n          };\n          const transformedRcNetworkTracking = transformedAutocaptureRemoteConfig.networkTracking;\n          /* istanbul ignore next */\n          const captureRules = transformedRcNetworkTracking.captureRules ?? [];\n          for (const rule of captureRules) {\n            rule.urls = mergeUrls(rule.urls ?? [], rule.urlsRegex, browserConfig);\n            delete rule.urlsRegex;\n          }\n        }\n\n        if (typeof browserConfig.autocapture === 'boolean') {\n          browserConfig.autocapture = {\n            attribution: browserConfig.autocapture,\n            fileDownloads: browserConfig.autocapture,\n            formInteractions: browserConfig.autocapture,\n            pageViews: browserConfig.autocapture,\n            sessions: browserConfig.autocapture,\n            elementInteractions: browserConfig.autocapture,\n            webVitals: browserConfig.autocapture,\n            frustrationInteractions: browserConfig.autocapture,\n            ...transformedAutocaptureRemoteConfig,\n          };\n        }\n\n        if (typeof browserConfig.autocapture === 'object') {\n          browserConfig.autocapture = {\n            ...browserConfig.autocapture,\n            ...transformedAutocaptureRemoteConfig,\n          };\n        }\n      }\n\n      // Override default tracking options if autocapture is updated by remote config\n      browserConfig.defaultTracking = browserConfig.autocapture;\n    }\n\n    browserConfig.loggerProvider.debug('Browser config after remote config update:', JSON.stringify(browserConfig));\n  } catch (e) {\n    browserConfig.loggerProvider.error('Failed to apply remote configuration because of error: ', e);\n  }\n}\n"]}